<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Session 10: High Performance | Unikraft Summer of Code 2021</title><meta property="og:title" content="Session 10: High Performance"><meta property="og:description" content="Requirements and Reminders For this session, you need Unikraft companion command-line tool kraft and the following extra tools:
 qemu-kvm qemu-system-x86_64 bridge-utils ifupdown tshark tcpdump  To install on Debian/Ubuntu use the following command:
$ sudo apt-get -y install qemu-kvm qemu-system-x86 sgabios socat bridge-utils ifupdown tshark tcpdump Configuring, Building and Running Unikraft At this stage, you should be familiar with the steps of configuring, building and running any application within Unikraft and know the main parts of the architecture."><meta property="og:type" content="article"><meta property="og:url" content="/docs/sessions/10-high-performance/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2021-09-04T11:50:35+03:00"><meta property="og:site_name" content="Unikraft Summer of Code 2021"><meta itemprop=name content="Session 10: High Performance"><meta itemprop=description content="Requirements and Reminders For this session, you need Unikraft companion command-line tool kraft and the following extra tools:
 qemu-kvm qemu-system-x86_64 bridge-utils ifupdown tshark tcpdump  To install on Debian/Ubuntu use the following command:
$ sudo apt-get -y install qemu-kvm qemu-system-x86 sgabios socat bridge-utils ifupdown tshark tcpdump Configuring, Building and Running Unikraft At this stage, you should be familiar with the steps of configuring, building and running any application within Unikraft and know the main parts of the architecture."><meta itemprop=dateModified content="2021-09-04T11:50:35+03:00"><meta itemprop=wordCount content="3682"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Session 10: High Performance"><meta name=twitter:description content="Requirements and Reminders For this session, you need Unikraft companion command-line tool kraft and the following extra tools:
 qemu-kvm qemu-system-x86_64 bridge-utils ifupdown tshark tcpdump  To install on Debian/Ubuntu use the following command:
$ sudo apt-get -y install qemu-kvm qemu-system-x86 sgabios socat bridge-utils ifupdown tshark tcpdump Configuring, Building and Running Unikraft At this stage, you should be familiar with the steps of configuring, building and running any application within Unikraft and know the main parts of the architecture."><link rel=preload href=/scss/main.min.1858cefeac68bf8654b05bceedf9634026955a53eb72683390eb36eb9c7a0dfc.css as=style><link href=/scss/main.min.1858cefeac68bf8654b05bceedf9634026955a53eb72683390eb36eb9c7a0dfc.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Unikraft Summer of Code 2021</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Workshop</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center d-lg-none"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Workshop</a></li><ul><li class="collapse show" id=docs><a class="td-sidebar-link td-sidebar-link__page" id=m-docssessionsschedule href=/docs/sessions/schedule/>Schedule</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoverviewpeople href=/docs/overview/people/>People</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions01-baby-steps href=/docs/sessions/01-baby-steps/>01. Baby Steps</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions02-behind-scenes href=/docs/sessions/02-behind-scenes/>02. Behind the Scenes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions03-debugging href=/docs/sessions/03-debugging/>03. Debugging in Unikraft</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions04-complex-applications href=/docs/sessions/04-complex-applications/>04. Complex Applications</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions05-contributing-to-unikraft href=/docs/sessions/05-contributing-to-unikraft/>05. Contributing to Unikraft</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions06-testing-unikraft href=/docs/sessions/06-testing-unikraft/>06. Testing Unikraft</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions07-syscall-shim href=/docs/sessions/07-syscall-shim/>07. Syscall Shim</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions08-basic-app-porting href=/docs/sessions/08-basic-app-porting/>08. Basic App Porting</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docssessions09-advanced-app-porting href=/docs/sessions/09-advanced-app-porting/>09. Advanced App Porting</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-docssessions10-high-performance href=/docs/sessions/10-high-performance/>10. High Performance</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docshackathon href=/docs/hackathon/>Hackathon</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/unikraft/summer-of-code-2021/edit/master/content/en/docs/sessions/10-high-performance/index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/unikraft/summer-of-code-2021/new/master/content/en/docs/sessions/10-high-performance/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/unikraft/summer-of-code-2021/issues/new?title=Session%2010:%20High%20Performance" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/unikraft/unikraft/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/docs/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><nav id=TableOfContents><ul><li><a href=#requirements-and-reminders>Requirements and Reminders</a><ul><li><a href=#configuring-building-and-running-unikraft>Configuring, Building and Running Unikraft</a></li></ul></li><li><a href=#overview>Overview</a></li><li><a href=#practical-work>Practical Work</a><ul><li><a href=#support-files>Support Files</a></li><li><a href=#01-getting-started>01. Getting Started</a></li><li><a href=#02-bring-up-a-network-interface>02. Bring Up a Network Interface</a></li><li><a href=#03-say-hello-on-the-wire>03. Say Hello on the Wire</a></li><li><a href=#04-dont-stop>04. Don&rsquo;t Stop</a></li><li><a href=#05-how-fast-are-we>05. How Fast Are We?</a></li><li><a href=#06-go-faster>06. Go Faster!</a></li><li><a href=#07-gimme-gimme-gimme>07. Gimme, gimme, gimme!</a></li><li><a href=#08-give-us-feedback>08. Give Us Feedback</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Workshop</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/sessions/10-high-performance/>10. High Performance</a></li></ol></nav><div class=td-content><h1>Session 10: High Performance</h1><h2 id=requirements-and-reminders>Requirements and Reminders</h2><p>For this session, you need Unikraft companion command-line tool <a href=https://github.com/unikraft/kraft><code>kraft</code></a> and the following extra tools:</p><ul><li><code>qemu-kvm</code></li><li><code>qemu-system-x86_64</code></li><li><code>bridge-utils</code></li><li><code>ifupdown</code></li><li><code>tshark</code></li><li><code>tcpdump</code></li></ul><p>To install on Debian/Ubuntu use the following command:</p><pre><code>$ sudo apt-get -y install qemu-kvm qemu-system-x86 sgabios socat bridge-utils ifupdown tshark tcpdump
</code></pre><h3 id=configuring-building-and-running-unikraft>Configuring, Building and Running Unikraft</h3><p>At this stage, you should be familiar with the steps of configuring, building and running any application within Unikraft and know the main parts of the architecture.
Below you can see a list of the commands you have used so far.</p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td><code>kraft list</code></td><td>Get a list of all components that are available for use with kraft</td></tr><tr><td><code>kraft up -t &lt;appname> &lt;your_appname></code></td><td>Download, configure and build existing components into unikernel images</td></tr><tr><td><code>kraft run</code></td><td>Run resulting unikernel image</td></tr><tr><td><code>kraft init -t &lt;appname></code></td><td>Initialize the application</td></tr><tr><td><code>kraft configure</code></td><td>Configure platform and architecture (interactive)</td></tr><tr><td><code>kraft configure -p &lt;plat> -m &lt;arch></code></td><td>Configure platform and architecture (non-interactive)</td></tr><tr><td><code>kraft build</code></td><td>Build the application</td></tr><tr><td><code>kraft clean</code></td><td>Clean the application</td></tr><tr><td><code>kraft clean -p</code></td><td>Clean the application, fully remove the <code>build/</code> folder</td></tr><tr><td><code>make clean</code></td><td>Clean the application</td></tr><tr><td><code>make properclean</code></td><td>Clean the application, fully remove the <code>build/</code> folder</td></tr><tr><td><code>make distclean</code></td><td>Clean the application, also remove <code>.config</code></td></tr><tr><td><code>make menuconfig</code></td><td>Configure application through the main menu</td></tr><tr><td><code>make</code></td><td>Build configured application (in <code>.config</code>)</td></tr><tr><td><code>qemu-guest -k &lt;kernel_image></code></td><td>Start the unikernel</td></tr><tr><td><code>qemu-guest -k &lt;kernel_image> -e &lt;directory></code></td><td>Start the unikernel with a filesystem mapping of <code>fs0</code> id from <code>&lt;directory></code></td></tr><tr><td><code>qemu-guest -k &lt;kernel_image> -g &lt;port> -P</code></td><td>Start the unikernel in debug mode, with GDB server on port <code>&lt;port></code></td></tr></tbody></table><h2 id=overview>Overview</h2><p>Welcome to the last session of the Unikraft Summer of Code!
In this session, we will introduce to you how to develop highly specialized and performance-optimized unikernels with Unikraft.
So far, we have focused on applications and POSIX compatibility;
where it is important to provide the same set of APIs and system calls that your application uses on its original environment (i.e., as a Linux user space application).
We achieve this by stacking multiple micro-libraries which then assemble together to form a combination of various necessary &ldquo;higher-level&rdquo; APIs .</p><p>In the context of network-based applications, we would typically develop network functionality based on <a href=https://linux.die.net/man/7/socket><code>sockets</code></a>.
This requires the following library stack being available within Unikraft for the <code>socket</code> (and friends) API to interface with the virtual Network Interface Card (vNIC):</p><pre><code> .-------------------------.
(     Socket application    )
 '-------------------------'
              |
              V
+---------------------------+
|         libvfscore        |
+---------------------------+
+---------------------------+
|          liblwip          |
+---------------------------+
+---------------------------+
|        libuknetdev        |
+---------------------------+
+---------------------------+
|        libkvmplat         |
+---------------------------+
              |
              V
 .-------------------------.
( Virtual Network Interface )
 '-------------------------'
</code></pre><p>Especially the Virtual File System (VFS) layer (provided by <a href=https://github.com/unikraft/unikraft/tree/staging/lib/vfscore><code>libvfscore</code></a>) and the TCP/IP network stack (provided by <a href=github.com/unikraft/lib-lwip/><code>liblwip</code></a>) are complex subsystems which are potentially introduce additional overheard.</p><p>For high-performance Network Functions (NFs), it is often more efficient to bypass any OS component and interact with the driver or hardware as directly; cutting out any indirection.
A known framework in the NFV arena is <a href=https://www.dpdk.org/>Intel DPDK</a> which operates network card drivers in Linux user space.
It operates in user space in order to avoid interactions with the kernel which comes with performance penalties resulting from additional permission checks.
Despite this advantage in performance, you still need to maintain and operate a complete Linux environment in production deployments.
In the case with Unikraft, we can configure the libraries to be minimal and can, similar to Intel DPDK, directly develop our NF on top of network drivers.</p><p>In this scenario, our library stack does look like the following:</p><pre><code> .-------------------------.
(    High performance NF    )
 '-------------------------'
              |
              V
+---------------------------+
|        libuknetdev        |
+---------------------------+
+---------------------------+
|        libkvmplat         |
+---------------------------+
              |
              V
 .-------------------------.
( Virtual Network Interface )
 '-------------------------'
</code></pre><p>In the following tutorial, you will develop a simple, high performance network packet generator.
This tutorial will guide you through various options and possibilities which can help you during the development of more complex NFs with Unikraft.</p><h2 id=practical-work>Practical Work</h2><h3 id=support-files>Support Files</h3><p>Session support files are available <a href=https://github.com/unikraft/summer-of-code-2021>in the USoC'21 repository</a>.
If you already cloned the repository, update it and enter the session directory:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#204a87>cd</span> path/to/repository/clone
$ git pull --rebase
$ <span style=color:#204a87>cd</span> content/en/docs/sessions/10-high-performance/
$ ls
</code></pre></div><pre><code>index.md  sol/
</code></pre><p>If you haven&rsquo;t cloned the repository yet, clone it and enter the session directory:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git clone https://github.com/unikraft/summer-of-code-2021
$ <span style=color:#204a87>cd</span> summer-of-code-2021/content/en/docs/sessions/10-high-performance/
$ ls
</code></pre></div><pre><code>index.md  sol/
</code></pre><h3 id=01-getting-started>01. Getting Started</h3><p>For this session, a template has been provided which contains some basic building blocks (like crafting a IPv4/UDP packet) for our high performance NF.
Start by making a copy of it:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ cp -a sol/pktgen path/to/your/copy
</code></pre></div><p>Go into your copy and initialize it with <code>kraft</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ <span style=color:#204a87>cd</span> path/to/your/copy
$ kraft list update
$ kraft list pull
$ kraft configure
$ kraft build
</code></pre></div><p>Check if the image runs and prints the Unikraft banner:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kraft run
</code></pre></div><h3 id=02-bring-up-a-network-interface>02. Bring Up a Network Interface</h3><p>We can directly interact with network device drivers which are typically provided by each platform using Unikraft&rsquo;s internal <a href=https://github.com/unikraft/unikraft/tree/staging/lib/uknetdev><code>uknetdev</code></a> API.
First, make sure that we state a dependency of our application to <code>libuknetdev</code>.
To do this, open <code>Config.uk</code> and place the following dependency accordingly in the file (if not already there): <code>depends on LIBUKNETDEV</code>.</p><p>This dependency gives us access to the <code>&lt;uk/netdev.h></code> and <code>&lt;uk/netbuf.h></code> headers which are available within the <code>libuknetdev</code> library:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ls <span style=color:#ce5c00;font-weight:700>[</span>PATH-TO-UNIKRAFT<span style=color:#ce5c00;font-weight:700>]</span>/lib/uknetdev/include/uk/
</code></pre></div><p>As described in <code>&lt;uk/netdev.h></code>, bringing up a network interface means transition it through configuration states before we can use the interface for sending packets:</p><ol><li><p>Check that the platform detected network interfaces.
<code>uk_netdev_count()</code> should tell us how many interfaces are available.
Please note that you should also check that the network driver is enabled in the platform configuration.
For this session we are interested in <code>virtio-net</code> within <code>KVM guest</code>.</p></li><li><p>Retrieve <code>struct uk_netdev *</code> for further API interaction from a netdev number (they are just incrementally going upwards).
We take the first interface, so our device number should be <code>0</code>.</p></li><li><p>Configure the device, which essentially indicate how many receive and transmit queues the device should provide.
In SMP scenarios, you typically configure as many queues as CPU-cores or handler threads you have been allocated.</p><p><strong>Note:</strong> Not every driver or network card can support multiple queues.</p><p>There is a query interface where you can check for queues are supported by your device.
For simplicity, we are going to configure just one queue for each direction.
This is supported by all drivers.
Although we are going to send packets only, we still have to also configure one receive queue (zero transmit or receive queues is not possible with our virtio driver):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/* Device configuration */</span>
<span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_netdev_conf</span> <span style=color:#000>ifconf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>.</span><span style=color:#000>nb_rx_queues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000;font-weight:700>.</span><span style=color:#000>nb_tx_queues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#000;font-weight:700>};</span>
</code></pre></div></li><li><p>Configure the transmit queue <code>0</code> and the receive queue <code>0</code>.
This step allows us to specify the size for each queue and which allocators should be used for internal queue descriptors and receive buffers.
We will take the default allocator for those items.
You can define a dummy allocation function for the receive buffers, because we are not interested in receiving for now.
We will also let the driver to choose an optimal queue size for us.
You can hand-over <code>0</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/* Dummy receive buffer allocation function that is called by the driver */</span>
<span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>uint16_t</span> <span style=color:#000>dummy_alloc_rxpkts</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>argp</span> <span style=color:#000>__unused</span><span style=color:#000;font-weight:700>,</span>
             <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_netbuf</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>pkts</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>__unused</span><span style=color:#000;font-weight:700>,</span>
             <span style=color:#000>uint16_t</span> <span style=color:#000>count</span> <span style=color:#000>__unused</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/* Receive queue configuration */</span>
<span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_netdev_rxqueue_conf</span> <span style=color:#000>rxqconf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
     <span style=color:#000;font-weight:700>.</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_alloc_get_default</span><span style=color:#000;font-weight:700>(),</span>
     <span style=color:#000;font-weight:700>.</span><span style=color:#000>alloc_rxpkts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dummy_alloc_rxpkts</span>
<span style=color:#000;font-weight:700>};</span>

<span style=color:#8f5902;font-style:italic>/* Transmit queue configuration */</span>
<span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_netdev_txqueue_conf</span> <span style=color:#000>txqconf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
     <span style=color:#000;font-weight:700>.</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_alloc_get_default</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>};</span>
</code></pre></div></li><li><p>Start the network interface.
If successful, the device is now ready to process network traffic.
You will now have the ability to also enable interrupt mode for each queue individually and change the promiscuous setting for the interface.
Because we will operate in <em>polling mode</em> to achieve the highest possible performance, we should not change any interrupt settings.
We also do not need promiscuous mode because we will put the device&rsquo;s hardware address as sender address into our generated traffic.
It is probably a good moment to print on the console this mac address and store it for later.
We will need it to craft our first network packet.</p></li></ol><p>For easier development of this state transition, we recommend to enable all kernel message types and optionally debug message (go to <code>Library Configuration</code> -> <code>ukbedug</code>).
Many of these steps should produce some kernel output so that you can quicker see if something got misconfigured.</p><p>In order to test your code you should run the guest with one interface attached.
For this purpose we need to create a network bridge on your Linux host first (we just need to do this once):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic># Ensure you have permissions to change stp</span>
sudo sysctl -w net.bridge.bridge-nf-call-arptables<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>

<span style=color:#8f5902;font-style:italic># Create bridge &#39;usocbr0&#39;</span>
brctl addbr usocbr0
brctl setfd usocbr0 <span style=color:#0000cf;font-weight:700>0</span>
brctl sethello usocbr0 <span style=color:#0000cf;font-weight:700>0</span>
brctl stp usocbr0 off
ifconfig usocbr0 0.0.0.0 up

<span style=color:#8f5902;font-style:italic># Disable packet filtering on bridge interfaces</span>
<span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>0</span> &gt; /proc/sys/net/bridge/bridge-nf-call-arptables
<span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>0</span> &gt; /proc/sys/net/bridge/bridge-nf-call-iptables
<span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>0</span> &gt; /proc/sys/net/bridge/bridge-nf-call-ip6tables
</code></pre></div><p>As soon as your unikernel image builds, the guest can then be started with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kraft run -b usocbr0
</code></pre></div><h3 id=03-say-hello-on-the-wire>03. Say Hello on the Wire</h3><p>In this chapter we are going to send out our first packet.
We provide you a function through the header <a href=https://github.com/unikraft/summer-of-code-2021/blob/main/content/en/docs/sessions/10-high-performance/sol/pktgen/genpkt.h><code>"genpkt.h"</code></a> which generates an Ethernet-IPv4-UDP frame with a dummy payload for a given size: <code>genpkt_udp4()</code>.
In the same header we also provide you the short-hand version <code>genpkt_usoc21()</code> which has some parameters, like the IP addresses, pre-filled.</p><p>The only items that the function still wants to know from you are the following:</p><ul><li><p><code>a</code>: Allocator where the packet should be allocated from.
Use <a href=https://github.com/unikraft/unikraft/blob/64870e20031aad230973b205ba80ff70a454c924/lib/ukalloc/include/uk/alloc.h#L135-L138><code>uk_alloc_get_default()</code></a> for now.</p></li><li><p><code>bufalign</code>: An alignment requirement for the packet buffer containing the packet.
Some network drivers require specific alignments.
You find this value after querying the device with <a href=https://github.com/unikraft/unikraft/blob/104fed122c41cbdedb03b701c19c38d4974cca34/lib/uknetdev/netdev.c#L217-L236><code>uk_netdev_info_get()</code></a> on <a href=https://github.com/unikraft/unikraft/blob/104fed122c41cbdedb03b701c19c38d4974cca34/lib/uknetdev/include/uk/netdev_core.h#L141-L150><code>struct uk_netdev_info</code></a> as <code>ioalign</code>.</p></li><li><p><code>headroom</code>: Reserved bytes at the beginning of the packet buffer and before the packet data starts.
Some drivers require this in order to do another encapsulation on transmit (like virtio).
You find this value on the <code>struct uk_netdev_info</code> as <code>nb_encap_tx</code>.</p></li><li><p><code>pktlen</code>: The size of the Ethernet frame (excluding CRC, FCS, SFD, and preamble) that should be generated.
According to the <a href=https://www.ietf.org/rfc/rfc1042.txt>Ethernet specification</a> the smallest packet size can be created with <code>60</code> and the biggest with <code>1518</code>.
The most interesting are minimum sized packets because those stress software and hardware components the most.
For each packet, the header needs to be parsed and the packet needs to get forwarded to the next processing layer of the stack.
As smaller the packets are, the more load with parsing and handling packet buffers occurs. So, please take <code>60</code> ;-)</p></li><li><p><code>mac_src</code>: The hardware address of our interface where we are going to send the packet out.</p></li></ul><p>The function returns you a <code>netbuf</code> that can be send out with <a href=https://github.com/unikraft/unikraft/blob/4e54f09a3930f0482a90903a5750c036346c7c06/lib/uknetdev/include/uk/netdev.h#L471-L508><code>uk_netdev_tx_one()</code></a>.
Please check the resulting status code for success and free the packet with <a href=https://github.com/unikraft/unikraft/blob/4e54f09a3930f0482a90903a5750c036346c7c06/lib/uknetdev/netbuf.c#L220-L254><code>uk_netbuf_free()</code></a> in case of failures.
The driver will do the free operation itself only if a packet got correctly enqueued to the device and sent.
In such a case, you aren&rsquo;t allowed to touch this packet anymore after sending;
so your transmit code should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>	<span style=color:#8f5902;font-style:italic>/* &lt;...&gt; */</span>

	<span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_netdev_tx_one</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>netif</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>uk_netdev_status_successful</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>uk_pr_err</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;netdev%u: Failed to send packet %p</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>,</span>
			  <span style=color:#000>uk_netdev_id_get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>netif</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
		<span style=color:#000>uk_netbuf_free</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/* Do not touch pkt here anymore */</span>
	<span style=color:#8f5902;font-style:italic>/* &lt;...&gt; */</span>
</code></pre></div><p>In order to see if everything works, attach <code>tshark</code> or <code>tcpdump</code> on your Linux host to <code>usocbr0</code> on a second terminal:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ tshark -i usocbr0
</code></pre></div><p>Whenever you launch your unikernel, you should be able to see the UDP packet:</p><pre><code>    3 1.050213439 192.168.128.1 → 192.168.128.254 UDP 60 5001 → 5001 Len=18
</code></pre><h3 id=04-dont-stop>04. Don&rsquo;t Stop</h3><p>Now let us send as much as we can with the current implementation.
You can simply loop forever over packet generation and sending.
You may notice that we get too many messages on the console that slow us down.
Try disabling debug messages and all kernel messages except the critical ones.</p><p><strong>Note</strong>: You should be able to terminate your unikernel with <code>CTRL</code>+<code>C</code> when you launched it with <code>kraft</code> or <code>qemu-guest</code>.</p><h3 id=05-how-fast-are-we>05. How Fast Are We?</h3><p>It is now interesting to understand at which speed we are generating.
For this purpose we prepared a little function in <a href=https://github.com/unikraft/summer-of-code-2021/blob/main/content/en/docs/sessions/10-high-performance/sol/pktgen/netspeed.h><code>"netspeed.h"</code></a> that computes the packet rate (packets/sec) and current bandwidth (MBit/s): <a href=https://github.com/unikraft/summer-of-code-2021/blob/main/content/en/docs/sessions/10-high-performance/sol/pktgen/netspeed.h#L93-L112><code>print_netspeed()</code></a>.</p><p>Declare before your loop the following two variables:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>uint64_t</span> <span style=color:#000>total_nb_pkts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>/* total number of pkts successfully sent */</span>
<span style=color:#000>uint64_t</span> <span style=color:#000>total_nb_bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>/* total number of bytes successfully sent */</span>
</code></pre></div><p>Whenever a packet was successfully sent, we will simply increment <code>total_nb_pkts</code> and add the sent bytes <code>total_nb_bytes</code> counters.
In order to see a bandwidth computation that is comparable with physical Ethernet speeds, we have to additionally add the number of bytes (=<code>24</code>) for CRC, FCS, SFD, and preamble to each accounted packet size:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>	<span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_netdev_tx_one</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>netif</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>uk_netdev_status_successful</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>/* success */</span>
		<span style=color:#000>total_nb_pkts</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
		<span style=color:#000>total_nb_bytes</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>60</span> <span style=color:#8f5902;font-style:italic>/* pktlen */</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>;</span>
	<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>/* failed */</span>
		<span style=color:#000>uk_netbuf_free</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
	<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>By having this instrumentation, we could now just print the packet rate and bandwidth at every loop iteration with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>	<span style=color:#000>print_netspeed</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_nb_pkts</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>total_nb_bytes</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>The problem is that printing is extremely expensive.
This is because it happens synchronously in Unikraft, so the CPU can not do anything else while waiting for the console to finish its operation.
Additionally, for computation, the clock is accessed to measure a time delta, which is also an expensive operation.
In general, this means that we do not want this function to be called very often.
The cheapest option is to call this print function every <code>n</code>th sent packet.
We could do a cheap modulo operation by using a bitmask, for example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>((</span><span style=color:#000>total_nb_pkts</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#0000cf;font-weight:700>0x3fffff</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0x0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>print_netspeed</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_nb_pkts</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>total_nb_bytes</span><span style=color:#000;font-weight:700>);</span>
		<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>You are able to adopt the mask <code>0x3fffff</code> in order to make printing more often or less often.</p><ul><li>Faster: <code>0x1fffff</code>, <code>0x0fffff</code>, <code>0x07ffff</code>, <code>0x03ffff</code>, <code>0x01ffff</code>, &mldr;</li><li>Slower: <code>0x7fffff</code>, <code>0xffffff</code>, <code>0x1ffffff</code>, <code>0x3ffffff</code>, <code>0x7ffffff</code>, &mldr;</li></ul><p>Another option is to use another counter variable that is reset as soon as we print:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>print_netspeed</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>total_nb_pkts</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>total_nb_bytes</span><span style=color:#000;font-weight:700>);</span>
			<span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
		<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Instrument your code with the two statistics variables and implement one of the mentioned printing mechanisms.
We should roughly print not faster than every <code>2</code> seconds, ideal are roughly <code>5</code>-<code>10</code> second intervals.
Remember, if your rate goes up or down with one of the following experiments, you may need to revisit your chosen value and adopt this <code>n</code>th packet parameter again.</p><h3 id=06-go-faster>06. Go Faster!</h3><p>Now, we have can go through some options to play around with.</p><p>Our overall goal is to get the packet rate of our packer generator as high as possible.
Note your rate and bandwidth before and, after each of the steps because we are going over this list twice, make sure that you do the steps non-destructive and keep the code of each step.</p><ol><li><p><strong>Try compiler options</strong>: Enable <em>Link Time Optimizations</em> (LTO) and <em>Dead Code Elimitation</em> (DCE) within <code>Build Options</code> of the <code>menuconfig</code>.
The compiler reconsiders a second time optimizations like function inlining while linking the final binary;
actually over the whole code base at once again.
These optimizations can have some visible effect on your packet rate.
Try it out!</p></li><li><p><strong>Don&rsquo;t waste packets</strong>: An obvious idea might be to keep packets which have failed to send.
We could save on packet generation time if we wouldn&rsquo;t free them.
We retry sending a packet until it finally leaves.
Our assumption is that the reason why it fails is that the transmit queue is full.
This approach can have positive but also likely negative effects.
The reason might be that some drivers may query their device more often to confirm that there is really no space left.
This causes the device to be busy answering instead of doing some actual work.
Try it out!</p></li><li><p><strong>Copy instead of create</strong>: Depending on how expensive the packet generation function is (e.g., because of an extra step computing a checksum), it could be cheaper to do a <code>memcpy</code> operation from a primordial packet buffer instead.
This means that we would run <code>genpkt_udp4()</code> just once and use as source for all cloned packets that are going to get transmitted.
We provide you such an extra routine with <code>"netbuf.h"</code>: <a href=https://github.com/unikraft/summer-of-code-2021/blob/main/content/en/docs/sessions/10-high-performance/sol/pktgen/netbuf.h#L45-L79><code>uk_netbuf_dup_single()</code></a> duplicates a given <code>netbuf</code> packet with <code>memcpy</code>.
Like <code>genpkt_udp4()</code>, it also needs the same extra information like <code>bufalign</code>, <code>headroom</code> for doing the allocation of the duplicate.
Try it out!</p></li><li><p><strong>Use a memory pool allocator</strong>: This is usually a very promising optimization.
Instead of using a general purpose allocator you can ensure that all <code>malloc</code> and <code>free</code> operations are satisfied within O(1).
If we deal with rates at maximum speed you want to have every job done as fast as possible.
A pool is basically a list of pre-allocated objects that have all the same size and an alignment property (if given).
On <code>malloc</code>, an object is returned out of this list;
on <code>free</code>, the object gets back to the free list.
For trying it out, continue with 06.1 and come back to point 5 of this list afterwards.</p></li><li><p><strong>Zero-copy with refcounting</strong>: Instead of all the optimization ahead, we could also simply increase the <code>netbuf</code> reference counter before sending.
This avoids that the packet being <code>free</code>&rsquo;d after sending and we would not need to allocate, copy, or generate a packet over and over again.
Every <code>free</code> operation will decrease the refcount until the reference counter becomes zero.
At this point the netbuf is really <code>free</code>&rsquo;d.
Unfortunately, we do not support this mode with network drivers which modify the packet for the transmission, like virtio-net does.
Unfortunately, it is not an option for virtio-net at the moment.
The transmit function will return an error.</p></li></ol><p>Besides these options, another common technique is using <strong>batching</strong>.
Instead of sending one packet at a time, you send multiple ones at once.
The advantage is that the device backend is notified just once per batch instead of for each packet.
This reduces communication overhead.
This feature is currently submitted as <a href=https://github.com/unikraft/unikraft/pull/243>PR#243</a> and will be added in the near future.</p><p>In order to understand better the bottlenecks in our implementation, we can isolate the code from the netdev device bottlenecks.
This is done by replacing the send operation with <code>uk_netbuf_free()</code>.
There we can assume that this means that every transmit operation works but this reveals more dominantly performance differences of the suggestions 1-5 ahead.
Go over the list again and note the new collected rates.
Which option results in the best performance?</p><p><strong>Recommendation</strong>: The pre-processor can help you switching between these two modes quickly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>#if 0</span><span style=color:#8f5902;font-style:italic> /* &lt;-- toggle between these two blocks with 0 and 1 */
</span><span style=color:#8f5902;font-style:italic>	status = uk_netdev_tx_one(netif, 0, pkt);
</span><span style=color:#8f5902;font-style:italic>	if (uk_netdev_status_successful(status)) {
</span><span style=color:#8f5902;font-style:italic>		/* success */
</span><span style=color:#8f5902;font-style:italic>		total_nb_pkts += 1;
</span><span style=color:#8f5902;font-style:italic>		total_nb_bytes += 60 /* pktlen */ + 24;
</span><span style=color:#8f5902;font-style:italic>	} else {
</span><span style=color:#8f5902;font-style:italic>		/* failed */
</span><span style=color:#8f5902;font-style:italic>		uk_netbuf_free(pkt);
</span><span style=color:#8f5902;font-style:italic>	}
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#else
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>uk_netbuf_free</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>/* always success */</span>
	<span style=color:#000>total_nb_pkts</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
	<span style=color:#000>total_nb_bytes</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>60</span> <span style=color:#8f5902;font-style:italic>/* pktlen */</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>#endif
</span></code></pre></div><h4 id=061-use-a-memory-pool>06.1. Use a memory pool</h4><p>We provide a pool allocator library with Unikraft: <code>libukallocpool</code>.
First of all, add a dependency to this library in your <code>Config.uk</code>:</p><pre><code>depends on LIBUKALLOCPOOL
</code></pre><p>This dependency makes the header <code>"&lt;uk/allocpool.h>"</code> (within <code>[PATH-TO-UNIKRAFT]/lib/ukallocpool/include/uk/</code>) available.</p><p>In order to allocate one pool, you call <code>uk_allocpool_alloc()</code> at your application startup.
The function will allocate the pool memory from a parent allocator.
This happens just during creation time for pre-allocating all the pool objects.</p><p>In our case this parent is the default allocator.
As <code>obj_len</code> you should choose <code>2048</code> because this is a big enough buffer to keep packet data and needed meta data.
<code>obj_align</code> should be again set to the alignment requirement of the device (<code>struct uk_netdev_info</code>-><code>ioalign</code>).
The <code>obj_count</code> argument should be big enough so that we do not run out of pool objects while sending.
You can try different values, start with <code>1024</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_allocpool</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>pool</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_allocpool_alloc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uk_alloc_get_default</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2048</span><span style=color:#000;font-weight:700>,</span>
                          <span style=color:#000>netdev_info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ioalign</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>In order to use the pool as allocator for <code>pktgen_udp4()</code> and <code>uk_netbuf_dup_single()</code>, you need to get the compatibility interface from libukallocpool:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_alloc</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>p</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_allocpool2ukalloc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pool</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p><code>p</code> can then be handed over as normal allocator, like <code>uk_alloc_get_default()</code>.
<code>p</code> will always return 2048B objects as long as the malloc request is smaller or equal to the initialized <code>obj_len</code>.
Any bigger allocation request cannot be satisfied and libukallocpool is returning <code>NULL</code>.</p><h3 id=07-gimme-gimme-gimme>07. Gimme, gimme, gimme!</h3><p>With the last task you will implement a receive-only unikernel that measures the received traffic.
We keep busy polling for receive as well but you should implement a switching logic to switch between transmit and receive mode.
You can do this either with a configuration option (<code>Config.uk</code>) or with a kernel argument (see: <code>int argc, char *argv[]</code>).</p><p>Opening the network device is the same for receive except that we implement and hand-over a proper receive buffer allocation function.
This will replace <code>dummy_alloc_rxpkts()</code> when the receive mode is activated.
We can use the same pool allocator that we allocated for transmit during task 06.1.</p><p>Whenever the driver calls our callback, it tries to setup new receive buffers to receive new packet data.
When filled, these buffers are later returned back to us.
The function should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/* global variables, fill-out before configuring the receive queue */</span>
<span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_netdev_info</span> <span style=color:#000>netdev_info</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_alloc</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>p</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000>uint16_t</span> <span style=color:#000>alloc_rxpkts</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>argp</span> <span style=color:#000>__unused</span><span style=color:#000;font-weight:700>,</span>
                      <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>uk_netbuf</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>pkts</span><span style=color:#000;font-weight:700>[],</span>
                      <span style=color:#000>uint16_t</span> <span style=color:#000>count</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>uint16_t</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>/* fill out given array with allocated receive buffers */</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>count</span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	    <span style=color:#000>pkts</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_netbuf_alloc_buf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#000;font-weight:700>,</span>
                                      <span style=color:#0000cf;font-weight:700>2048</span><span style=color:#000;font-weight:700>,</span>
                                      <span style=color:#000>netdev_info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ioalign</span><span style=color:#000;font-weight:700>,</span>
                                      <span style=color:#000>netdev_info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nb_encap_rx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>/* headroom for rx */</span>
                                      <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>);</span>
	    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>pkts</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>])</span>
			<span style=color:#204a87;font-weight:700>break</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>/* We ran out of memory */</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Please note that this function expects that we initialized the global variables <code>netdev_info</code> and <code>p</code> before we configure the receive queue.</p><p>Now you should be able to build the polling receive loop based on the following snippet:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uk_netdev_rx_one</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>netdev</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>uk_netdev_status_successful</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>/* count packet and bytes and free received packet */</span>
	<span style=color:#000>nb_total_pkts</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
	<span style=color:#000>nb_total_bytes</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>pkt</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>;</span>
	<span style=color:#000>uk_netbuf_free</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pkt</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>In order to test your configuration, you can run 2 unikernels that are both connected to <code>usocbr0</code>.
One is transmitting traffic and the other one receives it.</p><h3 id=08-give-us-feedback>08. Give Us Feedback</h3><p>We want to know how to make the next sessions better.
For this we need your <a href=https://forms.gle/hrWo9iuNWg4NeZWt6>feedback</a>.
Thank you!</p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/unikraft/summer-of-code-2021/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/unikraft/summer-of-code-2021/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified September 4, 2021: <a href=https://github.com/unikraft/summer-of-code-2021/commit/18c8d7c02cea01d5495b07ad5aa0c135c5e3f82a>Fix ukstore link and add more resources (18c8d7c)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel="noopener noreferrer" href=https://bit.ly/UnikraftDiscord><i class="fab fa-discord"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/UnikraftSDK><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/unikraft/unikraft><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel="noopener noreferrer" href=https://linkedin.com/company/unikraft-sdk><i class="fab fa-linkedin"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 Unikraft and Open-Source Contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script></body></html>